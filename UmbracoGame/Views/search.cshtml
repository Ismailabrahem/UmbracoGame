@using Umbraco.Cms.Web.Common.PublishedModels;
@using UmbracoGame.Models.ViewModels;
@using UmbracoGame.Models;

@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage<SearchPageViewModel>

@{
    Layout = "root.cshtml";
}

<link href="~/css/search.css" rel="stylesheet" />
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var searchButton = document.getElementById('searchButton');

        // Check if the page is refreshed
        var isRefreshed = performance.navigation.type === 1 ||
                          performance.getEntriesByType("navigation")[0].type === "reload";

        // Check if navigated from the navbar
        var fromNavbar = sessionStorage.getItem('fromNavbar');

        if (searchButton && (isRefreshed || fromNavbar === 'true')) {
            searchButton.click(); // Auto-click the search button
        }

        // Clear the flag after pressing the button
        sessionStorage.removeItem('fromNavbar');
    });
</script>


<div class="container">
    <!-- Search Form -->
    <div class="row mt-5">
        <div class="col-md-12">
            @using (Html.BeginUmbracoForm("SearchGame", "SearchSurface", FormMethod.Post, new { @class = "d-flex", @id = "searchForm" }))
            {
                <div class="input-group search-box">
                    <input class="form-control search-input" id="searchQuery" name="query" type="search" placeholder="Search for a game" aria-label="Search">
                    <button id="searchButton" class="input-group-text search-button" type="submit">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            }
        </div>
    </div>

    <!-- Search Results Grid -->
    <div class="search-container">
        @foreach (var item in Model.Games)
        {
            @using (Html.BeginUmbracoForm("GameDetails", "GameSurface", FormMethod.Post))
            {
                <div class="game-card">
                    <button class="btn game-card text-white rounded overflow-hidden transition-all d-flex flex-column position-relative cursor-pointer z-1 w-100 p-0 border-0 text-start">
                        <a href="/en/GamePage" class="text-decoration-none">
                            <!-- Game Media -->
                            <div class="game-media-container">
                                <img src="@(string.IsNullOrEmpty(item.BackgroundImage) ? "/media/y42flv5e/default-game-poster.jpg" : item.BackgroundImage)"
                                     class="game-image" alt="@item.Name" />
                            </div>

                            <!-- Game Info -->
                            <div class="game-info">
                                <h2 class="game-title">@item.Name</h2>
                                <p class="game-meta">
                                    @if (item.Released != null)
                                    {
                                        <span class="game-date">@item.Released</span>
                                    }
                                    @if (item.Metacritic != null)
                                    {
                                        <span class="game-rating">@item.Metacritic ★</span>
                                    }
                                </p>
                                <p class="game-platforms">
                                    @(item.Platforms?.Any() == true
                                        ? string.Join(", ", item.Platforms.Select(p => p.PlatformDetails?.Name ?? "Unknown"))
                                        : "No platforms available")
                                </p>
                                <p class="game-genres">
                                    @(item.Genres?.Any() == true
                                        ? string.Join(", ", item.Genres.Select(g => g.Name))
                                        : "No genres available")
                                </p>
                            </div>
                        </a>
                    </button>

                    <div class="game-hover-info">
                        <p><strong>Playtime:</strong> @item.Playtime hours</p>
                        <p><strong>Rating:</strong> @item.Rating</p>
                        <p><strong>ESRB:</strong> @(item.EsrbRating?.Name ?? "Not Rated")</p>
                    </div>



                        <input type="hidden" name="Id" value="@item.Id" />
                        <input type="hidden" name="Name" value="@item.Name" />
                        <input type="hidden" name="Slug" value="@item.Slug" />
                        <input type="hidden" name="Description" value="@item.Description" />
                        <input type="hidden" name="Metacritic" value="@item.Metacritic" />
                        <input type="hidden" name="Released" value="@item.Released" />
                        <input type="hidden" name="BackgroundImage" value="@item.BackgroundImage" />
                        <input type="hidden" name="Rating" value="@item.Rating" />
                        <input type="hidden" name="Playtime" value="@item.Playtime" />
                        <input type="hidden" name="Platforms" value="@string.Join(",", item.Platforms?.Select(p => p.PlatformDetails?.Name) ?? new List<string>())" />
                        <input type="hidden" name="Genres" value="@string.Join(",", item.Genres?.Select(g => g.Name) ?? new List<string>())" />
                        <input type="hidden" name="EsrbRating" value="@item.EsrbRating?.Name" />

                    
                                   
                </div>

            }
        }
    </div>
</div>


@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success">@TempData["SuccessMessage"]</div>
}
@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger">@TempData["ErrorMessage"]</div>
} 